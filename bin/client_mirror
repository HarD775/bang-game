#!/bin/sh
#
# $Id$
#
# Mirrors the Bang Howdy client deployment to the download servers

MIRROR=/export/tools/bin/mirror
ROOT=`dirname $0`/..
export JAVA_HOME=/usr/local/jdk1.5

# read in our deployment configuration
if [ -f $ROOT/deployment.properties ]; then
    egrep 'web_dir|client_ident' $ROOT/deployment.properties | \
        sed 's: = :=:g' > /tmp/deployment.conf
    . /tmp/deployment.conf
    rm /tmp/deployment.conf
else
    echo "Missing $ROOT/deployment.properties. Can't mirror."
    exit 255
fi

# figure out what version of the client we're deploying
CLIENT_DIR=$web_dir/$client_ident
. $ROOT/build.properties
if [ -z "$version" ]; then
    echo "Can't determine client version."
    exit 255
fi

# make sure the diffs are generated for all previous versions that are up
# to three months old
for FILE in `find $CLIENT_DIR/*/digest.txt -mtime -90`; do
    VERS=`dirname $FILE`
    VERS=`basename $VERS`
    if [ "$VERS" = "client" ]; then
        continue;
    fi
    if [ "$VERS" = "$version" ]; then
        continue;
    fi
    if [ -f $CLIENT_DIR/$version/patch$VERS.dat ]; then
        continue;
    fi
    echo "Creating patch file from version $VERS to $version..."
    cd $CLIENT_DIR
    $ROOT/projects/getdown/bin/differ $version $VERS
done

# mirror the client
echo "** Mirroring $client_ident version $version..."
$MIRROR $* `find $CLIENT_DIR/$version -type f`

# mirror the updated installers
$MIRROR $* $ROOT/pages/$client_ident/*-install.???

# mirror the in-client HTML
$MIRROR pages/*_news_incl.html

# mirror the Hemiptera Proguard mapping
$MIRROR $* $ROOT/../threerings/etc/proguard/bang/$version.map

# update the getdown.txt used by a fresh installation
cp $CLIENT_DIR/$version/getdown.txt $CLIENT_DIR
$MIRROR $* $CLIENT_DIR/getdown.txt
