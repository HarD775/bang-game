#!/bin/sh
#
# $Id$
#
# Mirrors the Bang Howdy client deployment to the download servers

MIRROR=/export/tools/bin/mirror
ROOT=`dirname $0`/..
export JAVA_HOME=/usr/local/java

# "parse" our arguments
VERBOSE=""
while [ ! -z "$1" ]; do
    if [ $1 = "-v" ]; then
        VERBOSE=true
    fi
    shift
done

# read in our deployment configuration
if [ -f $ROOT/deployment.properties ]; then
    egrep 'web_dir|client_ident' $ROOT/deployment.properties | \
        sed 's: = :=:g' > /tmp/deployment.conf
    . /tmp/deployment.conf
    rm /tmp/deployment.conf
else
    echo "Missing $ROOT/deployment.properties. Can't mirror."
    exit 255
fi

# figure out what version of the client we're deploying
CLIENT_DIR=$web_dir/$client_ident
. $ROOT/build.properties
if [ -z "$version" ]; then
    echo "Can't determine client version."
    exit 255
fi

# make sure the diffs are generated for all previous versions that are up
# to three months old
for FILE in `find $CLIENT_DIR/*/digest.txt -mtime -90`; do
    VERS=`dirname $FILE`
    VERS=`basename $VERS`
    if [ "$VERS" = "client" ]; then
        continue;
    fi
    if [ "$VERS" = "$version" ]; then
        continue;
    fi
    if [ -f $CLIENT_DIR/$version/patch$VERS.dat ]; then
        continue;
    fi
    echo "Creating patch file from version $VERS to $version..."
    cd $CLIENT_DIR
    $ROOT/projects/getdown/bin/differ $version $VERS
done

# mirror the client
echo "** Mirroring $client_ident version $version..."
$MIRROR $VERBOSE `find $CLIENT_DIR/$version -type f`

# mirror the updated installers
$MIRROR $VERBOSE $ROOT/pages/$client_ident/*-install.???

# TODO: copy getdown.txt to $ROOT/pages/$client_ident and mirror? Or do that in
# a separate finalize_release script
